# æ¦‚è¦
- class2apiå¸®åŠ©ä½ æŠŠJavascript Classç±»çš„é™æ€æ–¹æ³•è‡ªåŠ¨å‘å¤–æ˜ å°„ä¸ºAPIæŽ¥å£çš„å¾®åž‹æ¡†æž¶ï¼Œå€ŸåŠ©class2apiï¼Œä½ å¯ä»¥åœ¨1åˆ†é’Ÿä¹‹å†…ç›´æŽ¥å¼€å§‹ç€æ‰‹äºŽä¸šåŠ¡é€»è¾‘ä»£ç çš„ç¼–å†™ï¼Œè€Œå°†è·¯ç”±ã€æ–¹æ³•ç¼“å­˜ã€ç½‘ç»œé€šè®¯ç­‰äº‹åŠ¡äº¤ç»™æˆ‘ä»¬å¤„ç†
- class2apiæš´éœ²çš„APIæŽ¥å£ä»…ä»¥postæ–¹å¼æä¾›è¯·æ±‚æœåŠ¡ï¼ˆæ³¨æ„ï¼šä¸æ”¯æŒgetç­‰å…¶ä»–æ–¹å¼ï¼ï¼‰
- ä½œä¸ºå¾®æœåŠ¡ï¼Œä½¿ç”¨å†…ç½®Expressæ—¶ï¼Œclass2apiä¸å¼€å¯sessinã€‚æ³¨ï¼šå½“ä½¿ç”¨createServerInRouteræŒ‚è½½åˆ°çŽ°æœ‰çš„Expressåº”ç”¨ä¸‹æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å®¿ä¸»Expressåº”ç”¨çš„sessionæœºåˆ¶


# å¿«é€Ÿè¿è¡ŒDemoå‘å¯¼

- å¿«é€Ÿå®‰è£…ä¾èµ–ç»„å»º
```
$ npm i 
æˆ–
$ npm i --registry=https://registry.npm.taobao.org 
```

- åŸºäºŽæºç ç‰ˆæœ¬è¿è¡ŒDemoåº”ç”¨(Serverç‰ˆæœ¬)
```
$ npm run start:src 
```

- åŸºäºŽæºç ç‰ˆæœ¬è¿è¡ŒDemoåº”ç”¨(ExpressRouterè·¯ç”±ç‰ˆæœ¬)
```
$ npm run start:srcrouter
```

- è¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆå…ˆè¿è¡ŒDemoåº”ç”¨ï¼‰
```
$ mocha test/test.run
```

# å¿«é€Ÿåˆ›å»ºåº”ç”¨çš„ä»£ç 

## åˆ›å»ºä¸€ä¸ªä¸šåŠ¡ç±»ClassA.js
```javascript
    //ClassA.js
    class ClassA {
        static async hello({name}) {
            return {message: `this is a message from Api: got name [${name}]`}
        }
    } 
    export default ClassA
```

## æžé€Ÿåˆ›å»ºå¾®æœåŠ¡
```javascript
    //server.js
    import {createServer} from 'class2api'
    import ClassA from './ClassA'
    
    //åˆ›å»ºå¾®æœåŠ¡å¯¹è±¡
    createServer({
        modelClasses: [{model: ClassA, as: 'a'}],
        beforeCall:async ({req, params, modelSetting})=>{
            return params
        }
    }).then((server)=>{
        //å¼€å§‹ç›‘å¬æŒ‡å®šçš„ç«¯å£
        let port = 3002;
        server.listen(port, "0.0.0.0", function onStart(err){
            if (err) {
                console.log(err);
            }
            console.info("==> ðŸŒŽ Listening on port %s. Open up http://0.0.0.0:%s/ in your browser.", port, port);
        });
    }).catch((error)=>{
        setTimeout(function(){throw error})
    })
``` 

# ä¸šåŠ¡ç±»çš„çº¦å®šä¸Žæœ€ä½³å®žè·µï¼š
- ç±»åéœ€ä¸ºå‘½åç±»ï¼Œä¸èƒ½åŒ¿å
- ä¸šåŠ¡é™æ€ç±»ï¼Œä¸èƒ½æ‹¥æœ‰å®žä¾‹æ–¹æ³•ï¼ˆä¹Ÿæ²¡æœ‰éœ€æ±‚åœºæ™¯ï¼‰ï¼Œæ‰€ä»¥è¯·å‚è€ƒå®˜æ–¹ä»£ç ï¼Œåœ¨æž„é€ å™¨ä¸­throwå¼‚å¸¸ï¼Œä»¥ç¡®ä¿ä¸šåŠ¡é™æ€ç±»ä¸ä¼šè¢«å®žä¾‹åŒ–
- ç±»é™æ€æ–¹æ³•å®žçŽ°å„ä¸šåŠ¡é€»è¾‘
- ç±»é™æ€æ–¹æ³•åªæœ‰ä¸€ä¸ªå½¢å‚ï¼Œå¹¶ä»¥ES6å¯¹è±¡è§£æž„çš„æ–¹å¼ä¹¦å†™ï¼Œè°ƒç”¨ä»£ç å¯ä»¥èŽ·å¾—å‘½åå‚æ•°å½¢å¼çš„å¯è¯»æ€§ç›Šå¤„
- ç±»é™æ€æ–¹æ³•çš„å‚æ•°ï¼ˆé¦–ä¸ªå‚æ•°ï¼‰ä¸­ï¼Œæ¡†æž¶è¿˜æ³¨å…¥äº†å‡ ä¸ªå±žæ€§ï¼Œreqï¼šå½“å‰çš„è¯·æ±‚ä¿¡æ¯å¯¹è±¡ï¼Œexpressçš„æ ‡å‡†requestï¼Œä¾›æ–¹æ³•å†…éƒ¨è¯»å–ï¼›uIDï¼šç”¨æˆ·çš„å”¯ä¸€ç¼–ç ï¼Œå½“modelSettingä¿®é¥°å™¨ä¸­æŒ‡å®šçš„èº«ä»½éªŒè¯å‡½æ•°ï¼ˆ__Authï¼‰è¿è¡Œé€šè¿‡æ—¶å‡ºçŽ°ï¼›__nocacheï¼šè°ƒç”¨æ–¹ä¼ å…¥çš„ç‰¹æ®ŠæŒ‡ä»¤ï¼Œå½“__nocacheæœ‰å€¼æ—¶ï¼ŒcacheAbleä¿®é¥°å™¨å†…éƒ¨ä¼šåœ¨æœ¬æ¬¡è¯·æ±‚ä¸­å¿½ç•¥cacheAbleç¼“å­˜ç­–ç•¥ï¼Œç»§ç»­è¿è¡Œæ–¹æ³•ã€‚
- ä¸ºäº†å¢žåŠ APIè¿”å›žæ•°æ®å€¼çš„å¯æ‰©å±•èƒ½åŠ›ï¼Œç±»é™æ€æ–¹æ³•çš„è¿”å›žå€¼å¿…é¡»ç”¨å¯¹è±¡å½¢å¼ï¼Œä¸èƒ½ä½¿ç”¨å­—ç¬¦ä¸²ã€æ•´æ•°ã€æµ®ç‚¹ã€å¸ƒå°”ç­‰ç®€å•å€¼ç±»åž‹ã€‚
- æŸäº›åœºæ™¯ï¼Œåªéœ€è¦APIè¿”å›žæ“ä½œæ˜¯å¦æˆåŠŸçš„ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨å†…ç½®çš„GKSUCCESS(props)å‡½æ•°ï¼Œå®ƒå°è£…ä¸€ä¸ªç®€å•ç»“æž„{success: true,...props}ï¼Œå…¶ä¸­propså‚æ•°æ˜¯é™„åŠ ä¿¡æ¯ï¼Œå½“propsæ˜¯å¯¹è±¡æ˜¯ï¼Œè‡ªåŠ¨æ‰©å±•åˆ°ç»“æž„é‡Œï¼Œå½“propsæ˜¯éžå¯¹è±¡æ—¶ï¼Œä»¥msgå±žæ€§æ‰©å±•åˆ°ç»“æž„é‡Œ
```javascript
    import {GKSUCCESS} from 'class2api'
    class ClassA {
        constructor() {
            throw 'é™æ€ä¸šåŠ¡åŠŸèƒ½ç±»æ— æ³•å®žä¾‹åŒ–'
        }
        static async hello({name}) {
            return {message: `this is a message from Api: got name [${name}]`}
        }
        static async deleteArticle({name}) {
            return GKSUCCESS()
        }
    }
    export default ClassA
```

# å¯¼å‡ºåŠŸèƒ½å‡½æ•°

## class2apiç©ºé—´
- createServer(opts)
åˆ›å»ºæœåŠ¡å™¨(ä½¿ç”¨å†…å»ºçš„ç‹¬ç«‹Expresså®žä¾‹) ,optsä¸ºå‚æ•°é¡¹ï¼Œå…·ä½“å¦‚ä¸‹ï¼š
```javascript
    createServer({
        config:{
           apiroot:'/',//æŒ‚è½½å¾®æœåŠ¡çš„æ ¹è·¯å¾„ï¼Œå¦‚ï¼šapirootè®¾ç½®ä¸º'apiv1"ï¼Œåˆ™ä¸šåŠ¡ç±»ClassAçš„method1æ–¹æ³•å¯¹åº”çš„è®¿é—®å…¥å£ä¸º: http://yourdomain/apiv1/classa/method1
           redis,//å†…ç½®APIæ–¹æ³•ç¼“å­˜æ‰€ä½¿ç”¨çš„rediså®žä¾‹é…ç½®å‚æ•°ï¼Œä½¿ç”¨clearCacheã€cacheAbleä¿®é¥°å™¨æ—¶å¿…é¡»
           cros:true,//æ˜¯å¦å…è®¸è·¨åŸŸè®¿é—®
           cros_headers:[],//å…è®¸è·¨åŸŸè®¿é—®æ—¶çš„headersç™½åå•
           cros_origin:[],//å…è®¸è·¨åŸŸè®¿é—®æ—¶çš„æŽˆæƒæºé…ç½®ï¼Œé»˜è®¤ä¸º*ã€‚å½“ä¼ å…¥æœ‰æ•ˆçš„cros_originå‚æ•°æ—¶ï¼Œä»¥cros_originä¸­æŒ‡å®šçš„ä¸ºå‡†
           frontpage_default: '' //æ”¾åœ¨APIæ–¹æ³•å†…éƒ¨èŽ·å–å‰ç«¯çš„åŸŸåï¼Œä¸Žä»Žå‰ç«¯è¯·æ±‚ä¼ è¿‡æ¥headerä¸­çš„frontpageåˆå¹¶ï¼Œä¼˜å…ˆèŽ·å–å®¢æˆ·ç«¯çš„ï¼Œå…¶å®žé‡‡ç”¨æ­¤é»˜è®¤å€¼ã€‚æœ€åŽå°è£…ä¸ºæ ‡å‡†urlå¯¹è±¡å¹¶ç»‘å®šåˆ°APIæ–¹æ³•å›žè°ƒçš„paramså¯¹è±¡çš„___frontpageURLå±žæ€§ä¸Š
        }, 
        custom:(expressInstence)=>{
            //TODO:å¯¹expressInstenceå®žä¾‹è¿›è¡Œè‡ªå®šä¹‰æ‰©å±•ï¼Œæ³¨ï¼šä¸å»ºè®®å¢žåŠ sessionæœºåˆ¶
            return expressInstence
        },
        modelClasses, //æ˜ å°„çš„ä¸šåŠ¡ç±»åˆ—è¡¨ï¼Œå¦‚:[ClassA, {model:XXX,as:'abc'}]ï¼Œå»ºè®®ä»¥mode-asçš„æ–¹å¼ä¿®æ”¹ä¸šåŠ¡ç±»æš´éœ²çš„è®¿é—®è·¯å¾„ï¼Œä»¥éšè—å®žé™…çš„ç±»å‘½åï¼ˆå»ºè®®ï¼‰
        beforeCall, //APIæŽ¥å£è¯·æ±‚ä¹‹å‰çš„æ‹¦æˆªäº‹ä»¶ï¼Œå¯ä»¥ä¿®æ”¹ã€ç›‘å¬postä¿¡æ¯ï¼Œä»¥åŠèº«ä»½çš„éªŒè¯åˆ¤æ–­
        afterCall, //APIæŽ¥å£è¯·æ±‚å®ŒæˆåŽçš„æ‹¦æˆªäº‹ä»¶ï¼Œå¯ä»¥ä¿®æ”¹ã€ç›‘å¬è¿”å›žç»“æžœï¼Œå…¸åž‹åœºæ™¯å°±æ˜¯è®°å½•è¯·æ±‚çš„æ—¥å¿—
        method404//è‡ªå®šä¹‰çš„expressçš„è·¯ç”±ä¸­é—´ä»¶ï¼Œåœ¨404åœºæ™¯æ—¶ï¼Œå¯è¾“å‡ºè‡ªå·±å®šåˆ¶çš„è¿”å›žå€¼
    })
```

- createServerInRouter(opts)
åˆ›å»ºæœåŠ¡å™¨(ä½¿ç”¨å¤–éƒ¨çš„Expressï¼Œåªè¿”å›žrouterä¾›ç»‘å®šè·¯ç”±)ï¼Œoptså‚æ•°ä¸ŽcreateServerå‡½æ•°åŸºæœ¬ç›¸åŒï¼Œé™¤äº†è‡ªåŠ¨å¿½ç•¥customå‚æ•°

- setting_redisConfig
è®¾ç½®å†…ç½®redisçš„è¿žæŽ¥å‚æ•°ï¼Œå› ä¸ºè€ƒè™‘åˆ°importå£°æ˜Žè‡ªåŠ¨æå‰çš„é—®é¢˜ï¼Œä¸ºç¡®ä¿å…¶ä»–è‡ªå®šä¹‰ä¸šåŠ¡ç±»å†…éƒ¨åˆå§‹åŒ–æ—¶ä¾èµ–rediså®žä¾‹çš„åœºæ™¯ã€‚å»ºè®®çš„ï¼Œæœ€ä½³æ–¹æ³•æ˜¯å®šä¹‰ä¸ªç‹¬ç«‹çš„init.jsï¼Œå¹¶åœ¨server.jsé¡¶éƒ¨ç¬¬ä¸€è¡Œå¼•ç”¨
```javascript
//init.js
import {setting_redisConfig} from 'class2api'
setting_redisConfig({
                        host: "127.0.0.1",
                        port: 6379,
                        cache_prefx:'dev_class2api_',//å¿…é¡»çš„å‚æ•°ï¼Œä¸”é’ˆå¯¹æ¯ä¸ªåº”ç”¨ä¸åŒé…ç½®ï¼Œä»¥é¿å…å„åº”ç”¨ä¹‹é—´å‘ç”Ÿkeyç¢°æ’žä¸Žè¦†ç›–
                        defaultExpireSecond:10*60   //å¯ç¼ºçœï¼Œclass2apiå†…éƒ¨çš„é»˜è®¤æ··å­˜æ—¶é•¿ä¸º1åˆ†é’Ÿï¼Œå¯è‡ªå®šä¹‰
                    })
```

- getRedisClient
èŽ·å¾—redisè®¿é—®å®žä¾‹ï¼Œä»¥è¿›è¡Œç›´æŽ¥è¯»å–æ“ä½œ
```javascript
    let cache = getRedisClient()
    cache.set('keyABC','this is message!', (err,data)=>{})
    await cache.setAsync('keyABC','this is message!')
```

- GKErrorWrap
é”™è¯¯åŒ…è£…å™¨ï¼Œä»¥å¿«é€Ÿä»¥ä¸‹ç»“æž„çš„é”™è¯¯ä¿¡æ¯ï¼š
```javascript
return {
           _gankao: 1,//å›ºå®šæ ‡å¿—ä½ï¼Œä»¥åŒºåˆ«æ™®é€šçš„errorå¯¹è±¡
           code: errCode,//é”™è¯¯ç ï¼Œå†…ç½®é”™è¯¯ç±»åž‹ä¸ºè´Ÿæ•°ï¼Œé€šè¿‡GKErrorWrapè‡ªå®šä¹‰çš„codeè¯·åŠ¡å¿…ä¸ºæ­£æ•°
           message: `...`,//é”™è¯¯ä¿¡æ¯
           more: ''//è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
       }
``` 

- modelSetting(props)
ç±»ä¿®é¥°å™¨ï¼Œå°†ä¼ å…¥çš„propså¯¹è±¡èµ‹å€¼åˆ° Class.__modelSetting ä¸Šï¼Œç›®å‰class2apiå†…éƒ¨çº¦å®šçš„porpså±žæ€§æœ‰ï¼š
__Auth:Functionï¼Œä¸Žä¸šåŠ¡ç±»ç›¸å…³çš„èº«ä»½éªŒè¯å‡½æ•°ï¼Œå†…éƒ¨è¿›è¡Œèº«ä»½åˆ¤æ–­ï¼Œå¹¶è¿”å›žå¸¦æœ‰uIDçš„ç”¨æˆ·ä¿¡æ¯å¯¹è±¡
__ruleCategory:{name,desc}ï¼Œ
```javascript
    @modelSetting({
        __Auth:async ({req})=>{
            //åŽå°çš„ç”¨æˆ·éªŒè¯ï¼Œè§£æžheaderä¸­çš„jwtokenä¿¡æ¯ï¼Œè°ƒç”¨class2api/rulehelperçš„è§£æžï¼Œæ³¨æ„ä¸ŽéžåŽå°å¸¸è§„ç”¨æˆ·éªŒè¯çš„åŒºåˆ«
            let jwtoken = req.header('jwtoken') || ''
            return await parseAdminAccountFromJWToken({jwtoken})
        }
    })
    class GKModelA {
        constructor() {
            throw 'é™æ€ä¸šåŠ¡åŠŸèƒ½ç±»æ— æ³•å®žä¾‹åŒ–'
        }
    }
```

- cacheAble({cacheKeyGene:()=>{}})     
ç±»é™æ€æ–¹æ³•ä¿®é¥°å™¨,å¯¹ä¿®é¥°çš„APIæ–¹æ³•çš„è°ƒç”¨ç»“æžœè¿›è¡Œç¼“å­˜ï¼Œç¼“å­˜çš„keyç”±cacheKeyGeneå‡½æ•°è¿è¡Œæ—¶åŠ¨æ€è¿”å›žæŒ‡å®š
```javascript
    class GKModelA {
    
        @cacheAble({
            cacheKeyGene: (args) => {
                let {name} = args[0]
                return `getArticle-${name}`
            }
        })
        static async getArticle({uID, name}) { 
            return {message: `getArticle.${name}ï¼Œfrom user. ${uID}`}
        }
    }
```

- clearCache({cacheKeyGene:()=>{}}) 
ç±»é™æ€æ–¹æ³•ä¿®é¥°å™¨, å®žçŽ°åœ¨APIè¯·æ±‚å®Œæˆä¹‹åŽæ¸…ç©ºæŒ‡å®škeyçš„ç¼“å­˜ï¼Œåˆ é™¤çš„keyç”±cacheKeyGeneå‡½æ•°è¿è¡Œæ—¶åŠ¨æ€è¿”å›žæŒ‡å®šï¼›å¦‚æžœéœ€è¦æ¸…é™¤å¤šä¸ªkeyï¼Œå¯ä»¥ç”¨åè½¬æŽ§åˆ¶çš„æ–¹å¼ï¼Œäº¤ç»™ç±»é™æ€æ–¹æ³•å†…éƒ¨æ¥å¤„ç†ï¼Œå½“cacheKeyGeneå‡½æ•°è¿”å›ž''ç©ºå­—ç¬¦ä¸²ï¼Œä¼šå¼€å¯åè½¬æŽ§åˆ¶æ¨¡å¼ï¼Œä¿®é¥°å™¨å†…éƒ¨ä¼šåœ¨ç±»é™æ€æ–¹æ³•çš„ç¬¬ä¸€ä¸ªè°ƒç”¨å‚æ•°ï¼ˆæŒ‰çº¦å®šï¼Œç±»é™æ€æ–¹æ³•ä½¿ç”¨ç¬¬ä¸€ä¸ªå¤åˆå¯¹è±¡èŽ·å–æ‰€æœ‰çš„å‚æ•°ï¼‰ä¸­å¢žåŠ __cacheManageå±žæ€§ï¼Œ__cacheManageæ˜¯ä¸€ä¸ªè½»é‡cacheè®¿é—®å™¨ï¼Œæä¾›get(akey)ã€set(akey, avalue, expireTimeSeconds)ã€delete(akey)ä¸‰ä¸ªæ–¹æ³•ã€‚
```javascript

    //å¸¸è§„çš„æŽ§åˆ¶æ–¹å¼
    class GKModelA {
        @clearCache({
            cacheKeyGene: (args) => {
                let {aID} = args[0]
                return `article-${aID}`
            }
        })
        static async deleteArticle({aID}) {
            //...
            return GKSUCCESS()
        }
    }
    
    //éœ€è¦æ¸…é™¤å¤šä¸ªå…³è”keyæ—¶ï¼Œå¯ä½¿ç”¨åè½¬æŽ§åˆ¶æœºåˆ¶
    class GKModelA {
        @clearCache({
            cacheKeyGene: (args) => { 
                return ''
            }
        })
        static async deleteArticle({aID, __cacheManage}) {
            //...
            if(__cacheManage){
                await __cacheManage.delete(`article-${aID}`) //åˆ é™¤æ–‡ç« ç¼“å­˜
                await __cacheManage.delete(`articleCategory-1`) //åˆ é™¤æ–‡ç« ç±»åˆ«çš„ç¼“å­˜
            }
            return GKSUCCESS()
        }
    }
    
```

- accessRule   
ä¿®é¥°å™¨,æä¾›è®¿é—®æƒé™çš„æ ¡éªŒ
è¿è¡ŒåŽŸç†ï¼šä¿®é¥°å™¨å†…éƒ¨ä¼šæ‹¦æˆªæƒŠé›·
```javascript
    class GKModelA {
        constructor() {
            throw 'é™æ€ä¸šåŠ¡åŠŸèƒ½ç±»æ— æ³•å®žä¾‹åŒ–'
        }
     
        @accessRule({ruleName: 'åˆ é™¤æ–‡ç« ', ruleDescript: 'å¯¹æ–‡ç« è¿›è¡Œåˆ é™¤'})
        static async deleteArticle({aID}) {
            //...
            return GKSUCCESS()
        }
    }
```
- crashAfterMe(hintMsg)  ä¿®é¥°å™¨,è¿è¡Œå®Œç±»æ–¹æ³•å°±è®¤ä¸ºè·‘å‡ºå¼‚å¸¸ä¸­æ–­ç¨‹åºï¼Œè°ƒè¯•ç”¨ï¼Œç”Ÿäº§çŽ¯å¢ƒä¸‹è‡ªåŠ¨å¤±æ•ˆ


## class2api/gkerrors
- GKErrors  å¸¸ç”¨é¢„è®¾çš„é”™è¯¯ï¼ˆcodeå€¼ä¸ºè´Ÿæ•°ï¼‰
```javascript
    import {GKErrors} from 'class2api/gkerrors'
    //å†…ç½®çš„é”™è¯¯ä¿¡æ¯æœ‰ï¼š
    GKErrors._TOKEN_PARSE_FAIL      //tokenè§£æžå¤±è´¥ 
    GKErrors._RULE_VALIDATE_ERROR   //æƒé™è®¤è¯è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸
    GKErrors._TOKEN_LOGIN_INVALID   //è¯·å…ˆç™»å½•
    GKErrors._NOT_ACCESS_PERMISSION //æ— è®¿é—®æƒé™
    GKErrors._NOT_SERVICE       //åŠŸèƒ½å³å°†å®žçŽ°
    GKErrors._PARAMS_VALUE_EXPECT//å‚æ•°ä¸ç¬¦åˆé¢„æœŸ
    GKErrors._NO_RESULT         //æ— åŒ¹é…ç»“æžœ
    GKErrors._SERVER_ERROR      //æœåŠ¡å‘ç”Ÿå¼‚å¸¸
    GKErrors._NOT_PARAMS        //ç¼ºå°‘å‚æ•°
```

##class2api/dbhelper
sequelizeæ¨¡åž‹åˆ›å»ºä¸Žç®¡ç†çš„åŠ©æ‰‹å‡½æ•°ç©ºé—´ï¼Œå¯å‚è€ƒé¡¹ç›®ä¸­çš„tableloader.jsç¤ºä¾‹æ–‡ä»¶

- TableSetting  
sequelizeModelå®šä¹‰modelæ—¶çš„å‡ ä¸ªæ‰©å±•è®¾ç½®ï¼ŒåŒ…æ‹¬ï¼š
1ã€TableSetting.tabelOptionï¼Œmodelçš„å‡ ä¸ªé»˜è®¤è®¾ç½®ï¼Œparanoidé»˜è®¤ä¸ºtrueï¼Œæ—¶é—´ç›¸å…³å­—æ®µåå®šä¹‰ä¸ºcreated_atã€updated_atã€deleted_atï¼Œå­—ç¬¦é›†collateä¸ºutf8_general_ci
2ã€TableSetting.extendDateTimeVirtualFieldsè®¾ç½®ï¼Œä¸ºæ—¶é—´å­—æ®µæ‰©å±•å¯è¯»æ€§çš„æ—¶é—´æ ¼å¼åŒ–è™šå­—æ®µ

- ResetDB   
é‡ç½®æ•°æ®åº“ï¼Œå³æ‰§è¡Œsequelize.sync({force: (process.env.FORCE=="1")})ï¼Œå†…éƒ¨æœ‰å¯åŠ¨çŽ¯å¢ƒå˜é‡çš„æ ¡éªŒï¼Œåªæœ‰å½“ä¼ å…¥çš„å¯åŠ¨çŽ¯å¢ƒå˜é‡ä¸Žconfigä¸­mysql.reset_keyçš„{key1,key2}ç›¸ç¬¦æ—¶æ‰æ‰§è¡Œã€‚é»˜è®¤ä¸ºè½¯é‡ç½®ï¼Œå¯ä»¥é€šè¿‡ä¼ å…¥FORCE=1çš„å¯åŠ¨çŽ¯å¢ƒå˜é‡æ¥å¼ºåˆ¶é‡ç½®

- DBModelLoader 
åŠ è½½Modelå®šä¹‰æ–‡ä»¶, å‚è€ƒç¤ºä¾‹é¡¹ç›®ä¸­çš„tableloader.jsæ–‡ä»¶ï¼Œä»£ç æ®µï¼š
```javascript
    import {DBModelLoader} from 'class2api/dbhelper'
    import _config from './config'
    import DemoUser from './tables/DemoUser'
    
    //æ¨¡åž‹å®šä¹‰ï¼Œåœ¨aloader.initå†…éƒ¨ä¼šåŠ¨æ€åŠ è½½æŒ‡å®šçš„å®šä½æ–‡ä»¶ï¼Œæ›¿æ¢ä¸ºçœŸå®žçš„objectçš„valueå€¼
    export const DataModel = {
        DemoUser: DBModelLoader.define(DemoUser),
    }
    //ç»‘å®šæ¨¡åž‹å…³ç³»æ—¶ï¼Œå¯èƒ½éœ€è¦å®šä¹‰çš„åˆ«å
    export const ass = {
        subComment: "subComment",
        replyToUser: "replyToUser"
    }
    (async()=>{
        await DBModelLoader.INIT(_config.mysql, {model:DataModel, ass})
    })();
```
  
- DBUtils   
æ•°æ®åº“çš„è¾…åŠ©å·¥å…·æ–¹æ³•ï¼š
DBUtils.dumpModelFuns(sequelizeModelClass)  æ‰“å°æŒ‡å®šæ¨¡åž‹ç±»ä¸Šçš„sequelizeæ‰©å±•çš„ï¼Œæ“ä½œè‡ªèº«æ•°æ®å®žä¾‹çš„ã€ä»¥åŠæ“ä½œå…³è”å¯¹è±¡çš„å„ç±»å‡½æ•°æ–¹æ³•

- fn:Function        
sequezeliçš„èšåˆå‡½æ•°å¼•ç”¨

- col:Function       
sequezeliçš„åˆ—å‡½æ•°çš„å¼•ç”¨

- literal:Function   
sqlè¯­å¥å­—é¢é‡åŒ…è£…å‡½æ•°ï¼Œç¡®ä¿sequelizeä¸è§£æžæ­¤SQLå­—ç¬¦ä¸²

- where:Function     
sequezeliçš„whereå‡½æ•°çš„å¼•ç”¨

- createTransaction:Function
åˆ›å»ºä¸€ä¸ªsequezeliäº‹åŠ¡

- excuteSQL(sql,[replaceparam1,replaceparam2,...]) 
æ‰§è¡ŒæŒ‡å®šçš„SQLè¯­å¥ï¼Œä¸€èˆ¬é€‚ç”¨äºŽæ— æ³•ç”¨sequelizeè¡¨è¾¾å¼çš„å¤æ‚æŸ¥è¯¢

## class2api/testhelper
æµ‹è¯•è¾…åŠ©å‡½æ•°åº“ï¼Œä¸ºäº†æŽ¥è¿‘çœŸå®žçŽ¯å¢ƒï¼Œä»¥åŠç¡®ä¿æŽ¥å£è°ƒç”¨çš„å…¨æµç¨‹ï¼Œclass2apiçš„å•å…ƒæµ‹è¯•åŽŸåˆ™ä¸Šéƒ½ä»¥httpè°ƒç”¨çš„æ–¹å¼æ‰§è¡Œï¼Œè€Œé¿å…ç”¨ç±»è°ƒç”¨ã€‚
æ³¨ï¼šå½“éœ€è¦æµ‹è¯•ä¸šåŠ¡åŠŸèƒ½ç±»æœ¬èº«æ—¶ï¼Œè¿˜æ˜¯å¯ä»¥åœ¨ä¸šåŠ¡ç±»å±‚é¢ç›´æŽ¥è°ƒç”¨ï¼Œä»¥é¿å¼€å¾®æœåŠ¡æ¡†æž¶ä»¥åŠhttpé€šè®¯çš„å¹²æ‰°

- setApiRoot    å¾®æœåŠ¡APIçš„domain
- WebInvokeHepler(usertoken)(apiPath, postParams, apiDesc)      å‘apiå‘èµ·ä¸€ä¸ªpost-APIè¯·æ±‚ï¼Œ postParamsæ˜¯postçš„JSONå†…å®¹ï¼ŒapiDescæ˜¯APIæ–¹æ³•æè¿°çš„å‡½æ•°å°è£…ï¼ˆåªæ˜¯æé«˜å¯è¯»æ€§ï¼Œæ²¡æœ‰å®žé™…åŠŸèƒ½æ„ä¹‰ï¼‰
- ApiDesc       APIæ–¹æ³•æè¿°çš„å‡½æ•°å°è£…ï¼Œåªæ˜¯æé«˜åœ¨çœŸå®žå…¥å‚åˆ—è¡¨ä¸­çš„å¯è¯»æ€§ï¼Œæ²¡æœ‰å®žé™…åŠŸèƒ½æ„ä¹‰
- save2Doc      ä¿å­˜æœ¬æ¬¡mochaç”¨ä¾‹ä¸­æ‰€æœ‰æä¾›äº†ApiDescå‚æ•°çš„APIè¯·æ±‚çš„å…¥å‚ä¸Žè¿”å›žç»“æžœ
```javascript
    //æœ€å°åŒ–æ¡ˆä¾‹ 
    import {ApiDesc, WebInvokeHepler, setApiRoot, save2Doc} from 'class2api/testhelper'
    
    let _run = {
        accounts: {
            user1: {
                token: 'token-111'
            }
        }
    };
    //é€šè¿‡setApiRootï¼Œé™¤äº†æœ¬åœ°å¼€å‘çŽ¯å¢ƒï¼Œè¿˜å¯ä»¥è°ƒç”¨æµ‹è¯•çŽ¯å¢ƒã€æ­£å¼çŽ¯å¢ƒçš„æŽ¥å£ï¼Œè¿™ä¼šå¸¦æ¥æžå¤§çš„çº¿ä¸ŠæŽ’æŸ¥ä¸Žæ ¡éªŒçš„ä¾¿åˆ©æ€§
    const remote_api = process.env.ONLINE==='1'? `https://comment_api_test.gankao.com`
        :(process.env.ONLINE==='2'? `https://comment_api.gankao.com`
            :`http://127.0.0.1:3002`);
    //é…ç½®è¿œç¨‹è¯·æ±‚endpoint
    setApiRoot(remote_api);
    
    describe('è¯„è®ºç³»ç»Ÿ', function () {
     
        after(function () {
            save2Doc({save2File:'api.MD'})
        }); 
    
        it('/a/hello', async () => {
            let response = await WebInvokeHepler(_run.accounts.user1)('/a/hello',
                {name: "haungyong"},
                ApiDesc(`helloæµ‹è¯•æ–¹æ³•`)
            )
            let {err, result} = response
            let {message} = result
            message.lastIndexOf('haungyong').should.be.above(-1)
        }) 
    
    })
    
    

```


$ npm publish --registry=http://registry.npmjs.org  --  



